<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <script type="text/javascript"
                src="http://d3js.org/d3.v3.min.js">
        </script>
        <style type="text/css">
            path:hover{
                fill-opacity: .7;
            }
        </style>
    </head>

    <body>
        <script type="text/javascript">
   
            var w = 800;
            var h = 600;
            var projection = d3.geo.albersUsa()
                       .translate([w/2, h/2])
                       .scale([800]);
            var path = d3.geo.path().projection(projection);
            var svg = d3.select("body").append("svg")
                        .attr("width", w)
                        .attr("height", h);
            
            d3.json("us-states.json", function(error, json) {
                var states = svg.selectAll("path")
                    .data(json.features)
                    .enter()
                    .append("path")
                    .attr("d", path)
                    .attr("class","states")
                    .attr("stroke", "white")
                    .style("fill", "steelblue");


                d3.tsv("https://s3-us-west-2.amazonaws.com/vida-public/geo/us-state-names.tsv", function(error, names) {
                    var names_abbrev = {};
                    for (var i=0; i< names.length; i++) {

                        names_abbrev[names[i].name] = names[i].code;
                    }
                    console.log(names_abbrev);
                var g = svg.append("g");
                g.selectAll("text")
                .data(json.features)
                .enter()
                .append("svg:text")
                .text(function(d){
                    return names_abbrev[d.properties.name];
                })
                .attr("x", function(d){
                    return path.centroid(d)[0];
                })
                .attr("y", function(d){
                    return  path.centroid(d)[1];
                })
                .attr("text-anchor","middle")
                .attr('font-size','5pt')
                .attr('fill', 'black')

            d3.csv("./project_data/2015_R.csv", function(error, csvdata){
                if (error) {
                 return console.log(error);
                } else {
                    var value_range = [];
                    var values = [];
                    for (var i=0; i<csvdata.length;i++){
                        if (csvdata[i].OCC_GROUP == "total") {
                            var name = csvdata[i].STATE;
                            var value = csvdata[i].A_MEAN;
                            values[name] = value;
                            value_range.push(value);
                        }
                    }
                    console.log(values);
                    var maxvalue = d3.max(value_range);
                    var minvalue = d3.min(value_range);

                    var linear = d3.scale.linear()
                            .domain([minvalue, maxvalue])
                            .range([0, 1]);


            var a = d3.rgb(0,255,255);  //浅蓝色
            var b = d3.rgb(0,0,255);    //蓝色

            var computeColor = d3.interpolate(a,b);

            //设定各省份的填充色
            states.style("fill", function(d) {
                var t = linear(values[d.properties.name]);
                var color = computeColor(t);
                return color.toString();

        });
//            states.append("title")
//                    .on("mouseover", function(d) {return values[d.properties.name]} );

                    var defs = svg.append("defs");

                    var linearGradient = defs.append("linearGradient")
                            .attr("id","linearColor")
                            .attr("x1","0%")
                            .attr("y1","0%")
                            .attr("x2","100%")
                            .attr("y2","0%");

                    var stop1 = linearGradient.append("stop")
                            .attr("offset","0%")
                            .style("stop-color",a.toString());

                    var stop2 = linearGradient.append("stop")
                            .attr("offset","100%")
                            .style("stop-color",b.toString());

                    //添加一个矩形，并应用线性渐变
                    var colorRect = svg.append("rect")
                            .attr("x", 35)
                            .attr("y", 550)
                            .attr("width", 140)
                            .attr("height", 20)
                            .style("fill","url(#" + linearGradient.attr("id") + ")");

                    //添加文字
                    var minValueText = svg.append("text")
                            .attr("class","valueText")
                            .attr("x", 20)
                            .attr("y", 550)
                            .attr("dy", "-0.3em")
                            .text(function(){
                                return minvalue + "$";
                            });

                    var maxValueText = svg.append("text")
                            .attr("class","valueText")
                            .attr("x", 150)
                            .attr("y", 550)
                            .attr("dy", "-0.3em")
                            .text(function() {
                                        return maxvalue + "$";
                                    }
                                )}});
})});
        </script>
    </body>
</html>